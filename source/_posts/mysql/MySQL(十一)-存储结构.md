---
title: MySQL(十一)-存储结构
date: 2021-08-22 21:55:54
cover: /img/cover/MySQL.jpg
tags:
- 存储结构
categories:
- MySQL
updated: 2021-08-23 10:30:54
type:
comments:
description:
keywords:
top_img:
mathjax:
katex:
aside:
aplayer:
highlight_shrink:
---

#### 参考文献

* 极客时间--SQL必知必会(陈旸)

#### 数据库中存储结构

* 记录是按照行来存储的，但是数据库的读取并不是以行为单位，否则一次读取（也就是一次I/O操作）只能处理一行数据，效率会非常低，因此在数据库中，不论读一行，还是读多行，都是将这些行所在的页进行加载，也就是说，**数据库管理存储空间的基本单位是页(Page)**

* 一页中可以存储多个行记录(ROW)，同时在数据库中，还存在着区(Extent)，段(Segment)和表空间(Tablespace)。行，页，区，段，表空间的关系如下图：

  ![img](https://www.chenjunlin.vip/img/mysql/%E8%A1%8C,%E9%A1%B5,%E5%8C%BA,%E6%AE%B5,%E8%A1%A8%E7%A9%BA%E9%97%B4%E5%85%B3%E7%B3%BB.png)

  * 区是比页大一级的存储结构，在InnoDB存储引擎中，一个区会分配64个连续的页，因为InnoDB中的页大小默认是16KB，所以一个区的大小是64*16KB=1MB

  * 段由一个或多个区组成，区在文件系统是一个连续分配的空间（在InnoDB中连续的64个页），不过在段中不要求与区之间是相邻的，段是数据库中的分配单位，不同类型的数据库对象以不同的段形式存在。当创建数据表，索引的时候，就会相应的创建对应的段，比如创建一张表时会创建一个表段，创建一个索引就会创建一个索引段。

  * 表空间时一个逻辑容器，表空间存储的对象是段，在一个表空间中科院有一个或多个段，但是一个段只能属于一个表空间。数据库由一个或多个表空间组成，表空间从管理上可以划分为系统表空间，用户表空间，撤销表空间，临时表空间等。

  * 在InnoDB中存在两种表空间的类型：共享表空间和独立表空间。如果是共享表空间就是意味着多张表共用一个表空间。如果是独立表空间，就意味着每一张表有一个独立的表空间，也就是数据和索引信息都会保存在自己的表空间中。独立的表空间可以在不同的数据库之间进行迁移。

  * 可以通过`show variables like 'innodb_file_per_table';`

    ![img](https://www.chenjunlin.vip/img/mysql/innodb_file_per_table.png)

    * `Innodb_file_per_table=ON`，意味着每张表都会单独保存在一个`.ibd`文件

#### 数据页的结构

* 页如果按类型划分的话，常见的数据页(保存B+树节点),系统页,Undo页和事务数据等.数据页是最长用的页.

* 表页的大小限定了表行的最大长度,不同的DBMS的表页大小不同.在MySQL的InnoDB存储引擎中,默认页的大小是16KB.

  ![img](https://www.chenjunlin.vip/img/mysql/innodb_page_size.png)

* 数据库I/O操作的最小单位是页,与数据库相关的内容都会存储在页结构里.数据页包括七个部分
  * **文件头(File Header)**
  
  * **页头(Page Header)**
  
  * **最大最小记录(Infimum+supermum)**
  
  * **用户记录(User Records)**
  
  * **空闲空间(Free Space)**
  
  * **页目录(Page Directory)**
  
  * **文件尾(File Trailer)**
  
    | 名称             | 占用大小 | 说明                                |
    | ---------------- | -------- | ----------------------------------- |
    | File Header      | 38字节   | 文件头,描述页的信息                 |
    | Page Header      | 56字节   | 页头,页的状态信息                   |
    | infimum+Supermum | 26字节   | 最小和最大记录,这是两个虚拟的行记录 |
    | User Records     | 不确定   | 用户记录,存储行记录内容             |
    | Free Space       | 不确定   | 空闲空间,页中还没有被使用的空间     |
    | Page Directory   | 不确定   | 页目录,存储用户记录的相对位置       |
    | File Trailer     | 8字节    | 文件尾,校验页是否完整               |
  
  * 这7个数据页可分为3个部分
  
    * 首先是文件通用部分,也就是文件头和文件尾.类似集装箱,将页的内容进行封装,通过文件头和文件尾校验的方式来确保页的传输是完整的.
  
      * 文件头中有两个字段,分别是`FIL_PAGE_PREV`和`FIL_PAGE_NEXT`相当于指针,分别指向上一个数据页和下一个数据页.连接起来的页相当于一个双向链表.采用链表的结构让数据页之间不需要是物理上的连续,而是逻辑上的连续.
  
    * 第二部分是记录部分,页的主要作用是存储记录,所以"最小和最大记录"和"用户记录"部分占了页的主要空间.空闲空间是个灵活的部分,当有新的记录插入时,会从空闲空间中就进行分配用于存储新记录.
  
      ![img](https://www.chenjunlin.vip/img/mysql/%E8%AE%B0%E5%BD%95%E9%83%A8%E5%88%86.png)
  
    * 第三部分是索引部分,这部分重点指的是页目录,它起到了记录索引的作用,因为在页中,记录是以单链表的形式进行存储的.
  
* 页结构示意图:

  <img src="https://www.chenjunlin.vip/img/mysql/%E9%A1%B5%E7%BB%93%E6%9E%84%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="img" style="zoom:50%;" />

#### 从数据页的角度看B+树是如何查询的

* MySQL的InnoDB存储引擎采用B+树作为索引,索引又可以分为聚簇索引和非聚簇索引.

* 一颗B+树按照节点类型可以分为两个部分

  * 叶子节点,B+树最底层的节点,节点的高度尾0,存储行记录;
  * 非叶子节点,节点的高度大小0,存储索引键和页面指针,不存储行记录本身.

  <img src="https://www.chenjunlin.vip/img/mysql/B+%E6%A0%91%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="img" style="zoom:50%;" />

* B+是如何进行记录检索的?

  * 如果通过B+树的索引查询行记录,首先从B+树的根开始,逐层检索,直到找到叶子节点,也就是找到对应的数据页为止,将数据页加载到内存中,页目录中的槽(slot)采用二分查找的方式找到一个粗略的记录分组,然后再再分组中通过链表遍历的方式查找记录.


